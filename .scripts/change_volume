#!/bin/dash
# changeVolume

# Arbitrary but unique message tag
msgTag="myvolume"

# Change the volume using wpctl (PipeWire/WirePlumber), capped at 100%
wpctl set-volume --limit 1.0 @DEFAULT_AUDIO_SINK@ "$@"

# Query wpctl for the current volume and whether or not the speaker is muted
output="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"
mute="$(echo "$output" | grep -o '\[MUTED\]')"

if [ -n "$mute" ]; then
    # Show the sound muted notification
    dunstify -a "changeVolume" -u low -i audio-volume-muted -h string:x-dunst-stack-tag:$msgTag "ðŸ”‡ Muted"
else
    # Parse volume from wpctl output (format: "Volume: 0.50")
    volumeFloat="$(echo "$output" | awk '{print $2}')"
    # Subtract 0.01 to compensate for PipeWire's logarithmic scale, then convert to percentage, cap at 100
    volumePercent="$(awk "BEGIN {v = ($volumeFloat - 0.01) * 100; snapped = int((v + 2.5) / 5) * 5; if (snapped > 100) snapped = 100; printf \"%.0f\", snapped}")"
    dunstify -a "changeVolume" -u low -i audio-volume-high -h string:x-dunst-stack-tag:$msgTag -h int:value:"$volumePercent" "ðŸ”Š Volume: ${volumePercent}%"
fi

# Play the volume changed sound
canberra-gtk-play -i audio-volume-change -d "changeVolume"
